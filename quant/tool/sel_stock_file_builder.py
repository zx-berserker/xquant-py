# -*- encoding:utf-8 -*-
"""
date: 2020/8/26
author: Berserker
"""
import os
from pathlib import *
import struct


class SelStockFileBuilder(object):
    flex_sz_bytes = struct.pack('>H', 0x0721)
    flex_sh_bytes = struct.pack('>H', 0x0711)

    def __init__(self, path, name):
        self.path = path
        self.name = name
        self.sz_stock_code = []
        self.sh_stock_code = []

    def append_stock_code(self, stock_code):
        code_list = stock_code.split('.')
        if code_list[0] == 'sh':
            self.sh_stock_code.append(code_list[1])
        elif code_list[0] == 'sz':
            self.sz_stock_code.append(code_list[1])

    def __enter__(self):
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        if not self.path:
            self.path = os.getcwd()
        else:
            path = Path(self.path)
            if not path.exists():
                os.makedirs(self.path, 0o755)
        if not self.name:
            self.name = 'temp'

        name = self.name + '.sel'
        full_name = str(PureWindowsPath(self.path, name))
        with open(full_name, 'wb+', False) as writer:
            length = len(self.sz_stock_code) + len(self.sh_stock_code)
            length_bytes = struct.pack('H', length)
            writer.write(length_bytes)
            for code in self.sh_stock_code:
                writer.write(self.flex_sh_bytes)
                code_bytes = bytes(code, encoding="utf-8")
                writer.write(code_bytes)
            for code in self. sz_stock_code:
                writer.write(self.flex_sz_bytes)
                code_bytes = bytes(code, encoding="utf-8")
                writer.write(code_bytes)


def main():
    with SelStockFileBuilder('.', 'test') as builder:
        for i in range(0, 32):
            builder.append_stock_code("sz.000001")
            builder.append_stock_code("sh.600001")


# if __name__ == '__main__':
#     stock_lst = ["sz.300715","sz.300822","sz.301000","sz.301001","sz.301377","sz.301366","sz.301176","sz.301628","sz.300953","sz.300382","sz.300984","sz.300522","sz.300935","sz.301383","sz.300488","sz.300809","sz.301550","sz.300476","sz.301252","sz.301060","sz.301299","sz.300257","sz.300716","sz.300852","sz.301315","sz.300493","sz.301577","sz.301419","sz.300814","sz.301217","sz.300969","sz.301270","sz.300145","sz.301021","sz.301251","sz.300135","sz.301117","sz.300693","sz.300063","sz.301622","sz.300100","sz.300580","sz.301078","sz.300790","sz.300170","sz.301618","sz.300639","sz.301600","sz.300395","sz.300115","sz.300459","sz.300127","sz.300964","sz.300731","sz.300739","sz.300114","sz.300667","sz.301191","sz.300582","sz.300638","sz.301413","sz.301007","sz.301568","sz.300131","sz.300609","sz.300624","sz.301011","sz.300826","sz.300936","sz.300617","sz.300769","sz.301228","sz.300399","sz.301041","sz.300810","sz.300310","sz.301132","sz.301398","sz.300071","sz.301280","sz.300868","sz.301005","sz.300432","sz.300076","sz.301387","sz.300299","sz.300421","sz.300681","sz.300642","sz.300748","sz.301076","sz.300828","sz.301160","sz.301282","sz.300643","sz.300044","sz.300980","sz.300903","sz.301171","sz.300403","sz.301631","sz.300174","sz.300680","sz.301633","sz.300820","sz.300220","sz.300192","sz.301556","sz.300581","sz.301499","sz.300084","sz.300990","sz.300499","sz.301522","sz.301587","sz.301551","sz.300930","sz.300902","sz.300648","sz.301031","sz.301319","sz.301199","sz.300753","sz.300407","sz.301368","sz.300684","sz.301314","sz.300568","sz.301613","sz.300594","sz.301308","sz.301226","sz.301511","sz.301023","sz.301313","sz.300433","sz.300442","sz.301051","sz.301121","sz.300162","sz.300543","sz.300789","sz.300659","sz.301586","sz.300657","sz.301310","sz.301141","sz.301328","sz.300058","sz.301130","sz.300054","sz.301202","sz.300887","sz.300304","sz.300296","sz.301150","sz.301323","sz.300883","sz.300889","sz.300449","sz.300408","sz.300354","sz.301608","sz.301127","sz.300322","sz.300424","sz.300503","sz.300242","sz.300707","sz.301193","sz.300784","sz.300085","sz.300019","sz.300353","sz.301598","sz.300224","sz.301183","sz.301008","sz.300250","sz.300101","sz.300593","sz.300722","sz.300172","sz.300319","sz.300010","sz.300154","sz.300549","sz.301379","sz.301329","sz.301165","sz.300665","sz.301128","sz.300328","sz.301066","sz.300177","sz.301042","sz.300133","sz.301389","sz.300052","sz.301306","sz.300781","sz.301159","sz.300189","sz.301168","sz.301004","sz.300264","sz.300430","sz.300460","sz.300270","sz.300472","sz.300811","sz.301318","sz.300696","sz.300271","sz.300949","sz.300835","sz.300583","sz.300523","sz.300288","sz.301085","sz.300464","sz.300755","sz.301135","sz.300701","sz.300997","sz.301607","sz.301591","sz.301399","sz.300508","sz.300043","sz.301178","sz.300535","sz.300339","sz.301381","sz.300778","sz.300175","sz.300686","sz.300808","sz.300231","sz.300533","sz.300083","sz.300263","sz.300807","sz.300229","sz.301349","sz.300032","sz.300507","sz.300035","sz.300859","sz.300698","sz.300437","sz.300688","sz.300409","sz.300932","sz.301596","sz.300632","sz.301200","sz.300802","sz.300726","sz.300159","sz.301221","sz.301525","sz.301198","sz.301552","sz.300629","sz.300385","sz.300155","sz.300719","sz.301307","sz.301177","sz.301259","sz.300461","sz.301069","sz.300340","sz.301566","sz.301397","sz.300588","sz.300775","sz.300762","sz.301169","sz.300576","sz.301611","sz.300150","sz.300640","sz.300613","sz.300590","sz.300711","sz.300920","sz.300091","sz.301327","sz.301487","sz.300699","sz.300227","sz.300201","sz.301195","sz.300075","sz.300387","sz.301027","sz.301013","sz.300369","sz.301286","sz.300780","sz.300572","sz.300626","sz.300787","sz.300637","sz.300370","sz.300845","sz.301338","sz.300703","sz.300660","sz.300515","sz.301102","sz.300827","sz.301155","sz.300081","sz.300343","sz.300834","sz.300221","sz.300093","sz.300922","sz.301289","sz.300429","sz.301129","sz.300916","sz.301428","sz.300975","sz.300900","sz.301038","sz.300373","sz.300921","sz.300342","sz.300530","sz.300486","sz.300259","sz.301106","sz.300492","sz.301355","sz.300694","sz.300481","sz.300875","sz.300727","sz.300553","sz.300410","sz.301382","sz.301526","sz.300743","sz.300256","sz.300976","sz.300586","sz.300585","sz.300266","sz.301091","sz.300489","sz.300951","sz.300375","sz.301131","sz.300644","sz.300842","sz.300161","sz.300337","sz.300800","sz.300212","sz.300858","sz.300317","sz.300447","sz.300277","sz.301153","sz.300968","sz.300283","sz.300448","sz.301510","sz.301166","sz.300939","sz.300045","sz.300940","sz.301255","sz.300484","sz.300341","sz.300018","sz.300200","sz.300745","sz.301330","sz.301339","sz.300687","sz.300710","sz.300606","sz.300074","sz.301365","sz.300454","sz.300066","sz.300157","sz.300575","sz.301206","sz.300656","sz.300306","sz.300352","sz.300996","sz.301233","sz.301139","sz.300041","sz.300359","sz.300237","sz.300079","sz.301026","sz.300307","sz.300401","sz.300825","sz.300611","sz.301237","sz.301235","sz.300400","sz.300441","sz.301321","sz.300305","sz.300321","sz.300451","sz.301138","sz.300946","sz.300721","sz.300911","sz.300379","sz.300817","sz.300961","sz.301107","sz.301488","sz.300173","sz.300655","sz.301528","sz.300537","sz.300112","sz.301133","sz.300197","sz.301302","sz.300768","sz.301503","sz.300556","sz.300747","sz.300446","sz.301236","sz.301359","sz.300384","sz.300917","sz.300539","sz.300929","sz.300099","sz.300397","sz.300364","sz.301052","sz.300001","sz.300279","sz.301024","sz.300374","sz.301558","sz.301571","sz.300326","sz.300082","sz.300538","sz.301348","sz.301312","sz.300180","sz.300332","sz.300193","sz.301263","sz.300095","sz.300866","sz.300650","sz.301248","sz.301112","sz.300067","sz.300450","sz.301172","sz.300232","sz.301032","sz.301317","sz.300512","sz.300050","sz.300225","sz.301378","sz.301046","sz.301353","sz.300130","sz.301125","sz.300438","sz.300912","sz.300195","sz.301110","sz.300654","sz.301218","sz.301456","sz.300597","sz.300542","sz.300925","sz.300207","sz.300124","sz.300078","sz.301061","sz.300516","sz.301578","sz.301006","sz.300166","sz.301163","sz.300365","sz.301261","sz.301505","sz.300034","sz.301192","sz.301079","sz.301281","sz.301357","sz.300344","sz.300612","sz.300008","sz.301459","sz.301469","sz.301036","sz.300248","sz.300713","sz.300443","sz.300057","sz.300494","sz.300898","sz.301373","sz.301592","sz.300738","sz.300355","sz.300504","sz.300554","sz.300793","sz.300663","sz.300622","sz.301515","sz.301182","sz.301020","sz.300276","sz.300065","sz.301072","sz.300496","sz.301086","sz.300511","sz.301512","sz.301418","sz.300963","sz.300366","sz.300241","sz.300445","sz.300604","sz.301603","sz.301360","sz.301180","sz.300905","sz.300184","sz.300893","sz.300785","sz.300480","sz.300892","sz.301022","sz.300559","sz.300634","sz.300348","sz.300692","sz.301273","sz.300416","sz.300077","sz.300236","sz.300619","sz.301468","sz.300821","sz.300860","sz.300797","sz.300843","sz.300967","sz.300670","sz.300552","sz.301119","sz.300695","sz.300720","sz.300222","sz.300475","sz.301486","sz.300520","sz.301539","sz.301065","sz.300053","sz.300923","sz.301219","sz.300836","sz.301068","sz.300772","sz.300712","sz.300398","sz.300746","sz.300107","sz.301268","sz.300467","sz.300412","sz.300293","sz.300786","sz.300462","sz.300899","sz.300047","sz.300987","sz.300371","sz.301185","sz.300292","sz.301037","sz.300870","sz.300598","sz.300666","sz.300289","sz.300169","sz.300378","sz.300048","sz.300027","sz.301045","sz.301238","sz.300414","sz.300126","sz.301292","sz.300658","sz.301585","sz.300226","sz.300331","sz.300350","sz.300346","sz.301396","sz.300281","sz.301285","sz.300007","sz.300717","sz.300942","sz.300106","sz.300311","sz.300774","sz.300730","sz.300970","sz.300278","sz.301265","sz.300290","sz.301565","sz.301517","sz.300420","sz.300749","sz.300103","sz.301101","sz.300571","sz.301057","sz.300578","sz.300149","sz.301002","sz.301208","sz.300635","sz.300551","sz.300931","sz.301100","sz.300413","sz.301196","sz.301073","sz.301083","sz.301028","sz.300190","sz.301090","sz.300915","sz.300500","sz.301369","sz.301043","sz.301232","sz.300978","sz.300988","sz.300514","sz.301210","sz.301538","sz.300203","sz.300168","sz.300148","sz.300466","sz.300468","sz.300183","sz.300803","sz.300801","sz.301188","sz.300265","sz.300830","sz.301392","sz.300021","sz.301016","sz.300848","sz.300465","sz.301272","sz.300618","sz.300510","sz.300752","sz.300287","sz.300565","sz.301081","sz.300457","sz.300405","sz.300478","sz.301296","sz.300335","sz.300569","sz.300505","sz.300736","sz.300991","sz.300756","sz.301234","sz.300928","sz.300235","sz.301181","sz.300098","sz.300329","sz.300160","sz.300649","sz.300315","sz.300927","sz.300141","sz.301220","sz.300777","sz.300334","sz.300140","sz.300182","sz.300134","sz.300805","sz.300118","sz.301215","sz.301311","sz.301580","sz.300823","sz.300411","sz.300073","sz.300246","sz.300188","sz.300732","sz.300275","sz.300358","sz.300531","sz.301010","sz.301256","sz.300390","sz.300327","sz.300513","sz.300483","sz.300120","sz.300621","sz.300603","sz.300243","sz.300284","sz.301279","sz.301295","sz.301149","sz.300196","sz.300812","sz.300901","sz.300061","sz.300455","sz.301225","sz.301197","sz.300831","sz.300995","sz.301518","sz.301109","sz.300068","sz.301231","sz.300886","sz.300418","sz.301201","sz.300567","sz.301588","sz.300286","sz.301548","sz.301003","sz.300690","sz.301300","sz.300759","sz.301498","sz.300545","sz.301508","sz.300973"]

#     with SelStockFileBuilder('.','temp') as builder:
#         for stock in stock_lst:
#             builder.append_stock_code(stock)